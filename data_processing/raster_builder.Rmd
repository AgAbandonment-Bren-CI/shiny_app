---
title: "Global Raster Builder"
author: "Nick McManus"
date: "2023-02-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(terra)      #GIS
library(tidyverse)  #always
library(here)       #reading in data easily
```

# OVERVIEW:

This markdown serves to first calculated global cropland abandonment, then change the spatial extent and resolution of the cropland abandonment, global biodiversity, and global carbon layers. This produces new GeoTifs in the `data/processed` folder to be called on in the Shiny App. 





# GLOBAL CROPLAND ABANDONMENT

This section find areas of projected cropland abandonment in 2050 using land use and land cover (LULC) data from Chen et al. 2022. This source includes both projected LULC under different shared socioeconomic pathways (SSPs) as well as a baseline LULC data from 2015. The outputs from this code, rasters containing pixels of projected global cropland abandonment in 2050 for a given SSP, will be utilized for further analysis into conservation optimization. More information on the source data can be found in the project README.md file. 

Source: Chen, G., Li, X., & Liu, X. (2022). Global land projection based on plant functional types with a 1-km resolution under socio-climatic scenarios. Scientific Data, 9(1), 125. https://doi.org/10.1038/s41597-022-01208-6


### Read in and reclassify data

First read in projected 2050 LULC from Chen et al. for each SSP.
```{r}
# read in "baseline" 2015 LULC
PFT_2015 <- rast(here('data', 'raw', 'lulc', 'global_PFT_2015.tif'))

# SSP1
ssp1_PFT_2050 <- rast(here('data', 'raw', 'lulc', 'global_PFT_SSP1_RCP26_2050.tif'))
# SSP2
ssp2_PFT_2050 <- rast(here('data', 'raw', 'lulc', 'global_PFT_SSP2_RCP45_2050.tif'))
# SSP3  
ssp3_PFT_2050 <- rast(here('data', 'raw', 'lulc', "global_PFT_SSP3_RCP70_2050.tif"))  
# SSP4
ssp4_PFT_2050 <- rast(here('data', 'raw', 'lulc', "global_PFT_SSP4_RCP60_2050.tif")) 
# SSP5
ssp5_PFT_2050 <- rast(here('data', 'raw', 'lulc', "global_PFT_SSP5_RCP85_2050.tif"))
```


We are only interested in keeping values for pixels that reflect cropland and urban. Each layer will be reclassified to make all other variables 0.
```{r}
# create matrix for reclassification
reclass_df <- c(1, 0,	  #Water
                2, 0,	  #Broadleaf evergreen tree, tropical
                3, 0,	  #Broadleaf evergreen tree, temperate
                4, 0,	  #Broadleaf deciduous tree, tropical
                5, 0,	  #Broadleaf deciduous tree, temperate
                6, 0,	  #Broadleaf deciduous tree, boreal
                7, 0,	  #Needleleaf evergreen tree, temperate
                8, 0,	  #Needleleaf evergreen tree, boreal
                9, 0,	  #Needleleaf deciduous tree
                10, 0,	#Broadleaf evergreen shrub, temperate
                11, 0,	#Broadleaf deciduous shrub, temperate
                12, 0,	#Broadleaf deciduous shrub, boreal
                13, 0,	#C3 grass, arctic
                14, 0,	#C3 grass
                15, 0,	#C4 grass
                16, 0,	#Mixed C3/C4 grass
                17, 0,	#Barren
                18, 1,	#Cropland
                19, 10,	#Urban
                20, 0,  #Permanent snow and ice
                128, 0)	#N/A values

reclass_m <- matrix(reclass_df, ncol=2, byrow=TRUE)

# reclassify 2015 layer
crop_urban_2015 <- classify(PFT_2015, reclass_m)

# reclassify the rest of the projected layers
ssp1_2050_crop_urban <- classify(ssp1_PFT_2050, reclass_m)
ssp2_2050_crop_urban <- classify(ssp2_PFT_2050, reclass_m)
ssp3_2050_crop_urban <- classify(ssp3_PFT_2050, reclass_m)
ssp4_2050_crop_urban <- classify(ssp4_PFT_2050, reclass_m)
ssp5_2050_crop_urban <- classify(ssp5_PFT_2050, reclass_m)
```


### Calculate abandonment

Now that we've isolated layers of interest cropland, we want to determine where current cropland is projected to become "abandoned" in the future. This will be done with a simple raster calculation, subtracting the future cropland raster from the current cropland raster. Values of 0 indicate land that either remained cropland (1-1), remained urban (10-10), or remained non-cropland (0-0). Values of -1 indicate new future cropland (0-1) and values of -10 indicate areas of new urban (0-10). Values of 1 indicate abandoned cropland (1-0) that did not become urban, which are our pixels of interest! We will isolate these areas by reclassifying all non-one values to 0.
```{r}
# raster calculation between 2015 and 2050 LULC for each SSP
diff_ssp1_2050 <- crop_urban_2015 - ssp1_2050_crop_urban 
diff_ssp2_2050 <- crop_urban_2015 - ssp2_2050_crop_urban 
diff_ssp3_2050 <- crop_urban_2015 - ssp3_2050_crop_urban 
diff_ssp4_2050 <- crop_urban_2015 - ssp4_2050_crop_urban 
diff_ssp5_2050 <- crop_urban_2015 - ssp5_2050_crop_urban 

# all values that aren't 1 become 0
diff_ssp1_2050[diff_ssp1_2050 != 1] <- 0
diff_ssp2_2050[diff_ssp2_2050 != 1] <- 0
diff_ssp3_2050[diff_ssp3_2050 != 1] <- 0
diff_ssp4_2050[diff_ssp4_2050 != 1] <- 0
diff_ssp5_2050[diff_ssp5_2050 != 1] <- 0
```


### Change resolution

Our global abandonment layers are currently at 1km resolution. For processing speed and ease of visualization, we will change the resolution to 50km. These new 50km cells will represent "proportion of abandonment". 

```{r}
ssp1_agg <- aggregate(diff_ssp1_2050, fact = 50, fun = 'sum')
```



















